<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>所有商品</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/icons-extra.css" />
		<style>
			.mui-row.mui-fullscreen>[class*="mui-col-"] {
				height: 100%;
			}
			
			.mui-col-xs-3,
			.mui-col-xs-9 {
				overflow-y: auto;
				height: 100%;
			}
			
			.mui-segmented-control .mui-control-item {
				line-height: 50px;
				width: 100%;
			}
			
			.mui-control-content {
				display: block;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				background-color: #fff;
			}
			
			.mui-goods-size {
				position: relative;
				top: -8px;
				right: 5px;
				;
			}
			
			.mui-line-center {
				height: 30px;
				top: 0px !important;
			}
			
			.goodListUl {
				height: 200px;
			}
			
			.mui-popover {
				height: 300px;
			}
			
			#bottomPopover {
				font-size: 10px;
			}
			
			.goodName {
				width: 65%;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			
			.goodPrice {
				width: 20%;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">所有商品</h1>
		</header>
		<div class="mui-content mui-row mui-fullscreen">
			<div class="mui-col-xs-3">
				<div id="segmentedControls" class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-vertical">
				</div>
			</div>
			<div id="segmentedControlContents" class="mui-col-xs-9" style="border-left: 1px solid #c8c7cc;">
			</div>
		</div>
		<!--左下角弹出菜单-->
		<div id="bottomPopover" class="mui-popover mui-popover-bottom">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">

					</ul>
				</div>
			</div>
		</div>
		<nav class="mui-bar mui-bar-tab">
			<a class="mui-tab-item mui-active" href="#bottomPopover">
				<span class="mui-icon-extra mui-icon-extra-cart">
					<span class="mui-badge mui-badge-success mui-goods-size">0</span>
				</span>
			</a>
			<a class="mui-tab-item mui-active">
				<button type="button" class="mui-btn mui-btn-blue mui-btn-outlined mui-line-center placeOrder">下单</button>
			</a>
		</nav>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/util.js"></script>
	<script type="text/javascript" src="../../js/muiUtil.js"></script>
	<script>
		mui.init();
		//订单总商品个数
		var sumGoods = 0;
		//存入点击后的商品id
		var goodsArr = new Array();
		//是否从订单信息进入
		var orderInfoFlag = false;

		mui.plusReady(function() {
			var from = plus.webview.currentWebview().from;
			var goodList = plus.webview.currentWebview().goodList.toString();
			if(from == 'orderInfo') {
				goodsArr = goodList.split(',');
				sumGoods = goodsArr.length;
				orderInfoFlag = true;
			}
		});

		var controls = document.getElementById("segmentedControls");
		var contents = document.getElementById("segmentedControlContents");

		ajax('http://47.95.248.189/storeapp/bd_item_info.php', {}, function(data) {
			if(data == null || data == "") {
				mui.toast("查询商品失败");
			} else {
				var html = [];
				for(var i = 0; i < data.length; i++) {
					html.push('<a class="mui-control-item" data-index="' + i + '" href="#content' + i + '">' + data[i][0]['item_clsname'] + '</a>');
				}
				controls.innerHTML = html.join('');
				html = [];
				for(var i = 0; i < data.length; i++) {
					html.push('<div id="content' + i + '" class="mui-control-content"><ul class="mui-table-view">');
					for(var j = 0; j < data[i][1].length; j++) {
						//若果传过来的数组中有此商品，则放在购物车中
						if(isInArray(goodsArr, data[i][1][j]['item_no'])) {
							appendGoodsCar(data[i][1][j]['item_no'], data[i][1][j]['item_name'], formatNum(data[i][1][j]['price']), data[i][1][j]['unit_no']);
						}
						html.push('<li class="mui-table-view-cell" data-itemNo="' + data[i][1][j]['item_no'] + '" data-name="' + data[i][1][j]['item_name'] + '" data-price-type="' + data[i][1][j]['unit_no'] + '" data-price="' + data[i][1][j]['price'] + '">' + data[i][1][j]['item_name'] + '</a><span class="mui-pull-right">' + formatNum(data[i][1][j]['price']) + '元/' + data[i][1][j]['unit_no'] + '</span></li>');
					}
					html.push('</ul></div>');
				}
				//初始化个数以及金额
				showSumNum(goodsArr.length);
				contents.innerHTML = html.join('');
				//初始化列表
				controlInit();
				//初始化商品点击事件
				initClick();
			}
		});

		//底部价格计算 个数计算
		function showSumNum(sumGoods) {
			$(".mui-goods-size").text(sumGoods);
		}

		//添加购物车
		function appendGoodsCar(itemNo, goodsName, price, priceType) {
			$("#bottomPopover ul").append("<li class='mui-table-view-cell' data-itemNo='" + itemNo + "' data-price='" + price + "'>" +
				"<span class='mui-pull-left goodName'>" + goodsName + "</span>" +
				"<span class='mui-pull-left goodPrice'>" + price + "元/" + priceType + "</span>" +
				"<span class='mui-pull-right goodClose mui-icon mui-icon-close'></a>" +
				"</li>");
			//左下角滑动
			bottomPopoverScroll();
			//购物车删除商品事件
			goodsCarClick();
		}

		//左下角滑动
		function bottomPopoverScroll() {
			mui('.mui-scroll-wrapper').scroll();
		}

		//购物车删除商品事件
		function goodsCarClick() {
			//去除所有绑定事件，不去除的话一个li标签可能会多次绑定
			$("#bottomPopover ul li").unbind('tap');
			//重新绑定
			$("#bottomPopover ul li").on('tap', '.goodClose', function() {
				var itemNo = $(this).parent().attr("data-itemNo");
				$(this).parent().remove();
				sumGoods = utilFloatSub(sumGoods, 1);
				//刷新购物车数量以及金额预估
				showSumNum(sumGoods);
				//删除数组中的数据
				var index = goodsArr.indexOf(itemNo);
				if(index > -1) {
					goodsArr.splice(index, 1);
				}
			});
		};
		//初始化商品点击事件
		function initClick() {
			$(".mui-control-content ul").on('tap', 'li', function(e) {
				var itemNo = $(this).attr("data-itemNo");
				var goodName = $(this).attr("data-name");
				var price = formatNum($(this).attr("data-price"));
				//判断是否已经添加到购物车，如果已经添加则不重复添加
				if(isInArray(goodsArr, itemNo)) {
					mui.toast("已经添加" + goodName + "到购物车");
					return false;
				}
				//添加到数组中
				goodsArr.push(itemNo);
				var priceType = $(this).attr("data-price-type");
				//计算商品数
				sumGoods = utilFloatAdd(sumGoods, 1);
				//显示购物车数量
				showSumNum(sumGoods);
				//在购物车中显示
				appendGoodsCar(itemNo, goodName, price, priceType);
				mui.toast("成功添加" + goodName + "到购物车");
				if(orderInfoFlag) {
					var orderInfoPage = plus.webview.getWebviewById('orderInfo' + plus.webview.currentWebview().nowTime);
					mui.fire(orderInfoPage, 'addItemNo', {
						addItemNo: itemNo
					});
					
					mui.fire(orderInfoPage, 'addItemNo1', {
						addItemNo: itemNo
					});
					
					mui.fire(orderInfoPage, 'addItemNo2', {
						addItemNo: itemNo
					});
					mui.back();
				}
			});
		}
		//下单按钮
		$(".placeOrder").on('tap', function() {
			if(goodsArr.length == 0) {
				mui.alert('您还没有选择任何商品，暂时无法下单', '提示');
				return false;
			}
			//打开确认订单窗口
			openWindow("confirmOrder.html", "confirmOrder" + new Date(), {
				goodList: goodsArr.toString()
			});
		});
	</script>
</html>